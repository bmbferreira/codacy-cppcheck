Buffer 'var' is being written before its old content has been used. 'break;' missing?